<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rash Pro Test System</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
  <style>
    body{font-family:'Segoe UI', system-ui, sans-serif; background:#f4f7f9; padding:10px; margin:0; color:#333;}
    .container{max-width:550px; margin:auto; background:white; padding:15px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    .hidden{display:none;}
    .admin-card{background:#fff4e5; border:1px solid #f39c12; padding:10px; border-radius:10px; margin-bottom:15px;}
    .test-item{background:white; padding:8px; border-radius:5px; margin-top:5px; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center;}
    .btn{width:100%; padding:14px; border:none; border-radius:10px; color:white; font-size:15px; font-weight:bold; cursor:pointer; margin-top:10px; transition: 0.2s;}
    .btn-blue{background:#3498db;} .btn-green{background:#2ecc71;} .btn-orange{background:#f39c12;}
    input{width:100%; padding:10px; margin:5px 0 8px; border:1px solid #ccc; border-radius:8px; box-sizing:border-box; font-size:16px;}
    .q-card{border-bottom: 1px solid #eee; padding:15px 0;}
    .opt-btn{padding:10px 14px; margin:2px; border:1px solid #ccc; border-radius:6px; cursor:pointer; background:white; font-weight:bold;}
    .opt-btn.selected{background:#3498db; color:white;}
    .cat-btn{padding:5px 12px; font-size:11px; border:1px solid #ddd; border-radius:6px; cursor:pointer; background:#fff; font-weight: bold;}
    .cat-btn.active{background:#e67e22; color:white;}
    math-field{width:100%; border:1px solid #ccc; border-radius:8px; margin-top:5px; font-size:20px; background:white; min-height: 45px;}
    .status-box{padding:20px; border-radius:12px; text-align:center; font-weight:bold; margin-bottom:15px; line-height: 1.4;}
    #loader {text-align: center; padding: 20px;}
  </style>
</head>
<body>
<div class="container">
  <div id="loader">‚åõ Yuklanmoqda...</div>

  <!-- ADMIN -->
  <div id="adminArea" class="admin-card hidden">
    <div id="testListDisplay"></div>
    <button class="btn btn-blue" onclick="openNewForm()">‚ûï Yangi Test</button>
    <div id="adminForm" class="hidden">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <input type="number" id="adm_n1" value="0"> <input type="number" id="adm_n2" value="0">
        <input type="number" id="adm_n3" value="0"> <input type="number" id="adm_n4" value="0">
      </div>
      <input type="datetime-local" id="adm_start"> <input type="datetime-local" id="adm_end">
      <input type="text" id="adm_kod" placeholder="Test kodi">
      <input type="text" id="adm_channel" placeholder="Kanal ID (-100...)">
      <button class="btn btn-orange" onclick="renderAdminKeys()">üìù Javoblarni belgilash</button>
      <div id="keyArea" class="hidden"><div id="adminQuestions"></div><button class="btn btn-green" id="saveBtn" onclick="saveData()">üíæ Saqlash</button></div>
    </div>
  </div>

  <!-- USER -->
  <div id="userArea" class="hidden">
    <div id="statusBox" class="status-box"></div>
    <div id="paymentArea" class="hidden" style="text-align: center; border: 1px dashed red; padding: 15px; background: #fff5f5; border-radius: 12px;">
      <h4 style="color:red; margin: 0 0 10px 0;">üí≥ Ushbu test pullik!</h4>
      <p style="font-size: 13px;">Testda qatnashish uchun to'lovni amalga oshiring va adminga chek tashlang.</p>
      <div style="background: white; padding: 10px; border-radius: 8px; font-weight: bold; margin: 10px 0; border: 1px solid #ddd;">
        4073 4200 8458 9005<br><small>Adhamov A</small>
      </div>
      <button class="btn btn-blue" onclick="window.open('https://t.me/user16801680', '_blank')">üë§ Adminga yozish</button>
      <button class="btn btn-orange" style="margin-top:5px; font-size:12px;" onclick="location.reload()">üîÑ To'lovdan so'ng tekshirish</button>
    </div>
    <div id="loginForm" class="hidden">
      <input type="text" id="userKod" placeholder="Test kodini kiriting">
      <button class="btn btn-blue" onclick="accessTest()">Testni boshlash</button>
    </div>
    <div id="testArea" class="hidden"><div id="studentQuestions"></div><button id="subBtn" class="btn btn-green" onclick="submitTest()">üì§ Topshirish</button></div>
  </div>

  <div id="finalMsg" class="hidden" style="text-align:center; padding:40px;"></div>
</div>

<script>
  const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxLU69C4qhGxXjdmmUQP4q-ydof6MlEq7U6Q3LtNzrVrjtLjVCameCFbN8XGq5jFw/exec"; 
  let userId = String(tg.initDataUnsafe.user?.id || "");
  let serverData = { testList: [], isAdmin: false, submittedTests: [] };
  let adminKeys = {}, adminCats = {}, studentAns = {}, activeTest = null;

  async function load() {
    try {
      const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
      serverData = await res.json();
      document.getElementById('loader').classList.add('hidden');
      if (serverData.isAdmin) { document.getElementById('adminArea').classList.remove('hidden'); displayAdminTests(); }
      document.getElementById('userArea').classList.remove('hidden');
      checkGlobalStatus();
    } catch (e) { document.getElementById('loader').innerText = "Xato!"; }
  }

  function displayAdminTests() {
    const cont = document.getElementById('testListDisplay');
    cont.innerHTML = serverData.testList.map(t => `<div class="test-item">
      <span><b>${t.kod}</b></span>
      <div><button onclick="calculateRash('${t.kod}')">üìä</button><button onclick="editTest('${t.kod}')">‚úèÔ∏è</button><button onclick="deleteTest('${t.kod}')">üóëÔ∏è</button></div>
    </div>`).join('') || "Testlar yo'q.";
  }

  function checkGlobalStatus() {
    const now = new Date();
    const active = serverData.testList.filter(t => new Date(t.start) <= now && new Date(t.end) > now);
    const upcoming = serverData.testList.filter(t => new Date(t.start) > now).sort((a,b)=>new Date(a.start)-new Date(b.start));
    const box = document.getElementById('statusBox');
    if (active.length > 0) { box.innerHTML = "‚úÖ Test faol! Kodni kiriting."; box.style.background = "#d4edda"; document.getElementById('loginForm').classList.remove('hidden'); }
    else if (upcoming.length > 0) { box.innerHTML = `‚è≥ Kutilmoqda. <br><small>Boshlanish: ${new Date(upcoming[0].start).toLocaleString('uz-UZ')}</small>`; box.style.background = "#fff3cd"; }
    else { box.innerHTML = "üì≠ Hozirda mavjud testlar yo'q."; box.style.background = "#e9ecef"; document.getElementById('loginForm').classList.add('hidden');}
  }

  async function accessTest() {
    const k = document.getElementById('userKod').value.trim();
    const t = serverData.testList.find(x => x.kod.toLowerCase() === k.toLowerCase());
    if(!t) return alert("Kod xato!");
    if(serverData.submittedTests.includes(k)) return alert("Topshirib bo'lingan!");

    document.getElementById('loader').classList.remove('hidden');
    const res = await fetch(`${SCRIPT_URL}?action=checkMembership&userId=${userId}&testKod=${k}`);
    const check = await res.json();
    document.getElementById('loader').classList.add('hidden');

    if (check.status !== "member") {
        document.getElementById('loginForm').classList.add('hidden');
        document.getElementById('paymentArea').classList.remove('hidden');
        return;
    }

    activeTest = t;
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('testArea').classList.remove('hidden');
    const cont = document.getElementById('studentQuestions'); cont.innerHTML = "";
    let q = 1;
    for(let i=0; i<parseInt(t.n1); i++) createQ(cont, q++, ['A','B','C','D'], "user", "mcq");
    for(let i=0; i<parseInt(t.n2); i++) createQ(cont, q++, ['A','B','C','D','E','F'], "user", "mcq");
    for(let i=0; i<parseInt(t.n3); i++) createQ(cont, q++, null, "user", "double");
    for(let i=0; i<parseInt(t.n4); i++) createQ(cont, q++, null, "user", "single");
  }

  function createQ(p, n, opts, mode, type) {
    const d = document.createElement('div'); d.className = 'q-card';
    const obj = (mode === 'admin') ? adminKeys : studentAns;
    if (mode === 'admin' && !adminCats[n]) adminCats[n] = 'alg';
    if (mode === 'admin') {
      let cd = document.createElement('div'); cd.style.marginBottom="5px";
      cd.innerHTML = `<button class="cat-btn ${adminCats[n]==='alg'?'active':''}" onclick="adminCats[${n}]='alg'; this.parentElement.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active')">Alg</button><button class="cat-btn ${adminCats[n]==='geo'?'active':''}" onclick="adminCats[${n}]='geo'; this.parentElement.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active')); this.classList.add('active')">Geo</button>`;
      d.appendChild(cd);
    }
    let t = document.createElement('b'); t.innerText = n + ". "; d.appendChild(t);
    if (type === "mcq") {
      let s = document.createElement('span');
      opts.forEach(o => {
        let b = document.createElement('button'); b.className = 'opt-btn'+(obj[n]===o?' selected':''); b.innerText = o;
        b.onclick = () => { obj[n]=o; s.querySelectorAll('.opt-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); };
        s.appendChild(b);
      });
      d.appendChild(span || s);
    } else if (type === "double") {
      const v = (mode==='admin' && adminKeys[n]) ? adminKeys[n] : {a:'', b:''};
      let div = document.createElement('div'); div.innerHTML = `a)<math-field id="q${n}a" value="${v.a}"></math-field> b)<math-field id="q${n}b" value="${v.b}"></math-field>`;
      d.appendChild(div);
      setTimeout(() => {
        document.getElementById(`q${n}a`).addEventListener('input', (e) => { if(!obj[n])obj[n]={a:'',b:''}; obj[n].a=e.target.value; });
        document.getElementById(`q${n}b`).addEventListener('input', (e) => { if(!obj[n])obj[n]={a:'',b:''}; obj[n].b=e.target.value; });
      }, 0);
    } else {
      const v = (mode==='admin') ? (adminKeys[n]||'') : '';
      let mf = document.createElement('math-field'); mf.value = v; mf.addEventListener('input', (e) => { obj[n]=e.target.value; });
      d.appendChild(mf);
    }
    p.appendChild(d);
  }

  function openNewForm() { document.getElementById('adminForm').classList.remove('hidden'); adminKeys={}; adminCats={}; }
  function renderAdminKeys() {
    const n1=parseInt(document.getElementById('adm_n1').value)||0, n2=parseInt(document.getElementById('adm_n2').value)||0, n3=parseInt(document.getElementById('adm_n3').value)||0, n4=parseInt(document.getElementById('adm_n4').value)||0;
    if(n1+n2+n3+n4===0) return alert("Soni?");
    document.getElementById('keyArea').classList.remove('hidden');
    const c = document.getElementById('adminQuestions'); c.innerHTML="";
    let q=1;
    for(let i=0; i<n1; i++) createQ(c, q++, ['A','B','C','D'], "admin", "mcq");
    for(let i=0; i<n2; i++) createQ(c, q++, ['A','B','C','D','E','F'], "admin", "mcq");
    for(let i=0; i<n3; i++) createQ(c, q++, null, "admin", "double");
    for(let i=0; i<n4; i++) createQ(c, q++, null, "admin", "single");
  }
  async function saveData() {
    const p = { action: "save", n1: +document.getElementById('adm_n1').value, n2: +document.getElementById('adm_n2').value, n3: +document.getElementById('adm_n3').value, n4: +document.getElementById('adm_n4').value, start: document.getElementById('adm_start').value, end: document.getElementById('adm_end').value, kod: document.getElementById('adm_kod').value, keys: adminKeys, cats: adminCats, channelId: document.getElementById('adm_channel').value };
    await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify(p)}); location.reload();
  }
  function calculateRash(k){ fetch(SCRIPT_URL,{method:'POST', body:JSON.stringify({action:"calculate",kod:k})}).then(()=>alert("OK")); }
  function deleteTest(k){ if(confirm("O'chirilsinmi?")) fetch(SCRIPT_URL,{method:'POST', body:JSON.stringify({action:"delete",kod:k})}).then(()=>location.reload()); }
  function editTest(kod) {
    const t = serverData.testList.find(x => x.kod === kod);
    document.getElementById('adm_n1').value = t.n1; document.getElementById('adm_n2').value = t.n2;
    document.getElementById('adm_n3').value = t.n3; document.getElementById('adm_n4').value = t.n4;
    document.getElementById('adm_start').value = t.start.split('.')[0]; document.getElementById('adm_end').value = t.end.split('.')[0];
    document.getElementById('adm_kod').value = t.kod; document.getElementById('adm_kod').disabled = true;
    document.getElementById('adm_channel').value = t.channelId || ""; adminKeys = t.keys || {}; adminCats = t.cats || {}; document.getElementById('adminForm').classList.remove('hidden'); renderAdminKeys();
  }
  async function submitTest() { document.getElementById('subBtn').disabled = true; await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:"submit", userId:userId, kod: activeTest.kod, answers:studentAns})}); tg.close(); }

  load();
</script>
</body>
</html>


