<!-- Buni GitHub Pages yoki Vercel-ga yuklang -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
  <style>
    body{font-family:sans-serif; background:#f4f7f9; padding:10px;}
    .container{max-width:550px; margin:auto; background:white; padding:15px; border-radius:15px; box-shadow:0 2px 10px rgba(0,0,0,0.1);}
    .hidden{display:none;}
    .admin-card{background:#fff4e5; border:1px solid #f39c12; padding:10px; border-radius:10px; margin-bottom:15px;}
    .test-item{background:white; padding:8px; border-radius:5px; margin-top:5px; border-left:4px solid #f39c12; display:flex; justify-content:space-between; align-items:center;}
    .btn{width:100%; padding:12px; border:none; border-radius:8px; color:white; cursor:pointer; font-weight:bold; margin-top:10px;}
    .btn-blue{background:#3498db;} .btn-green{background:#2ecc71;}
    input{width:100%; padding:10px; margin:5px 0; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;}
    .q-card{border-bottom:1px solid #eee; padding:10px 0;}
    .opt-btn{padding:8px; margin:2px; border:1px solid #ccc; border-radius:5px; cursor:pointer; background:white;}
    .opt-btn.selected{background:#3498db; color:white;}
    .cat-btn{padding:4px 8px; font-size:10px; border:1px solid #ddd; border-radius:4px; cursor:pointer; background:#eee;}
    .cat-btn.active{background:#e67e22; color:white;}
    math-field{width:100%; border:1px solid #ccc; border-radius:5px; margin-top:5px;}
  </style>
</head>
<body>
<div class="container">
  <div id="loader">‚åõ Yuklanmoqda...</div>

  <!-- ADMIN AREA -->
  <div id="adminArea" class="admin-card hidden">
    <h4>üõ† Boshqaruv</h4>
    <div id="testListDisplay"></div>
    <button class="btn btn-blue" onclick="openNew()">‚ûï Yangi Test</button>
    <div id="adminForm" class="hidden">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
        <input type="number" id="adm_n1" value="1" title="A-D"> <input type="number" id="adm_n2" value="1" title="A-F">
        <input type="number" id="adm_n3" value="1" title="a/b"> <input type="number" id="adm_n4" value="1" title="Ochiq">
      </div>
      <input type="datetime-local" id="adm_start"> <input type="datetime-local" id="adm_end">
      <input type="text" id="adm_kod" placeholder="Test kodi">
      <button class="btn btn-blue" onclick="renderKeys()">üìù Javob va Fanlar</button>
      <div id="keyArea" class="hidden"><div id="adminQs"></div><button class="btn btn-green" onclick="save()">üíæ Saqlash</button></div>
    </div>
  </div>

  <!-- USER AREA -->
  <div id="userArea" class="hidden">
    <div id="statusBox" style="text-align:center; padding:10px; font-weight:bold;"></div>
    <div id="loginForm" class="hidden">
      <input type="text" id="userKod" placeholder="Test kodini kiriting">
      <button class="btn btn-blue" onclick="access()">Boshlash</button>
    </div>
    <div id="testArea" class="hidden"><div id="studentQs"></div><button id="subBtn" class="btn btn-green" onclick="submit()">üì§ Topshirish</button></div>
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp; tg.ready(); tg.expand();
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyWWAbKyu13_E39TpvtKqX89jdibyJq1d-vw_rNgj7PJF9JD_h2EA-qHiDjXdtbHYmr/exec";
  let userId = String(tg.initDataUnsafe.user?.id);
  let server = {}; let adminKeys = {}; let adminCats = {}; let studentAns = {}; let activeTest = null;

  async function load() {
    const res = await fetch(`${SCRIPT_URL}?userId=${userId}`);
    server = await res.json();
    document.getElementById('loader').classList.add('hidden');
    if (server.isAdmin) { document.getElementById('adminArea').classList.remove('hidden'); showAdminList(); }
    document.getElementById('userArea').classList.remove('hidden');
    checkStatus();
  }

  function showAdminList() {
    const cont = document.getElementById('testListDisplay');
    cont.innerHTML = server.testList.map(t => `<div class="test-item">
      <span><b>${t.kod}</b></span>
      <div><button onclick="calc('${t.kod}')">üìä</button><button onclick="edit('${t.kod}')">‚úèÔ∏è</button><button onclick="del('${t.kod}')">üóëÔ∏è</button></div>
    </div>`).join('') || "Test yo'q.";
  }

  async function calc(k){ await fetch(SCRIPT_URL,{method:'POST', body:JSON.stringify({action:"calculate",kod:k})}); alert("Hisoblandi!"); }

  function openNew(){ document.getElementById('adminForm').classList.remove('hidden'); adminKeys={}; adminCats={}; }

  function edit(kod) {
    const t = server.testList.find(x => x.kod === kod);
    document.getElementById('adm_n1').value=t.n1; document.getElementById('adm_n2').value=t.n2;
    document.getElementById('adm_n3').value=t.n3; document.getElementById('adm_n4').value=t.n4;
    document.getElementById('adm_start').value=t.start; document.getElementById('adm_end').value=t.end;
    document.getElementById('adm_kod').value=t.kod; adminKeys=t.keys; adminCats=t.cats||{}; renderKeys();
    document.getElementById('adminForm').classList.remove('hidden');
  }

  function renderKeys() {
    document.getElementById('keyArea').classList.remove('hidden');
    const c = { n1: +document.getElementById('adm_n1').value, n2: +document.getElementById('adm_n2').value, n3: +document.getElementById('adm_n3').value, n4: +document.getElementById('adm_n4').value };
    genUI(document.getElementById('adminQs'), c, "admin");
  }

  async function save() {
    const p = { action: "save", n1: +document.getElementById('adm_n1').value, n2: +document.getElementById('adm_n2').value, n3: +document.getElementById('adm_n3').value, n4: +document.getElementById('adm_n4').value, start: document.getElementById('adm_start').value, end: document.getElementById('adm_end').value, kod: document.getElementById('adm_kod').value, keys: adminKeys, cats: adminCats };
    await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify(p)});
    location.reload();
  }

  function checkStatus() {
    const now = new Date(); const has = server.testList.some(t => new Date(t.end) > now);
    const box = document.getElementById('statusBox');
    box.innerHTML = has ? "‚úÖ Faol testlar bor." : "üì≠ Mavjud testlar yo'q.";
    if(has) document.getElementById('loginForm').classList.remove('hidden');
  }

  function access() {
    const k = document.getElementById('userKod').value.trim(); const t = server.testList.find(x => x.kod === k);
    if(!t) return alert("Xato!");
    activeTest = t; document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('testArea').classList.remove('hidden'); genUI(document.getElementById('studentQs'), t, "user");
  }

  function genUI(cont, conf, m) {
    cont.innerHTML = ""; let q=1;
    for(let i=0; i<conf.n1; i++) addM(cont, q++, ['A','B','C','D'], m);
    for(let i=0; i<conf.n2; i++) addM(cont, q++, ['A','B','C','D','E','F'], m);
    for(let i=0; i<conf.n3; i++) addD(cont, q++, m);
    for(let i=0; i<conf.n4; i++) addS(cont, q++, m);
  }

  function addM(p, n, os, m) {
    const d = document.createElement('div'); d.className = 'q-card';
    const ks = (m==='admin')?adminKeys:studentAns;
    let cat = m==='admin' ? `<div><button class="cat-btn ${adminCats[n]==='alg'?'active':''}" onclick="setCat(${n},'alg',this)">Alg</button><button class="cat-btn ${adminCats[n]==='geo'?'active':''}" onclick="setCat(${n},'geo',this)">Geo</button></div>` : "";
    d.innerHTML = `${cat} <b>${n}.</b> <span>${os.map(o => `<button class="opt-btn ${ks[n]===o?'selected':''}" onclick="sel(${n},'${o}','${m}',this)">${o}</button>`).join('')}</span>`;
    p.appendChild(d);
  }

  function addD(p, n, m) {
    const d = document.createElement('div'); d.className = 'q-card';
    const v = (m==='admin')? (adminKeys[n]||{a:'',b:''}):{a:'',b:''};
    let cat = m==='admin' ? `<div><button class="cat-btn ${adminCats[n]==='alg'?'active':''}" onclick="setCat(${n},'alg',this)">Alg</button><button class="cat-btn ${adminCats[n]==='geo'?'active':''}" onclick="setCat(${n},'geo',this)">Geo</button></div>` : "";
    d.innerHTML = `${cat} <b>${n}.</b> a)<math-field value="${v.a}" oninput="upD(${n},'a','${m}',this)"></math-field> b)<math-field value="${v.b}" oninput="upD(${n},'b','${m}',this)"></math-field>`;
    p.appendChild(d);
  }

  function addS(p, n, m) {
    const d = document.createElement('div'); d.className = 'q-card';
    const v = (m==='admin')? (adminKeys[n]||''):'';
    let cat = m==='admin' ? `<div><button class="cat-btn ${adminCats[n]==='alg'?'active':''}" onclick="setCat(${n},'alg',this)">Alg</button><button class="cat-btn ${adminCats[n]==='geo'?'active':''}" onclick="setCat(${n},'geo',this)">Geo</button></div>` : "";
    d.innerHTML = `${cat} <b>${n}.</b> <math-field value="${v}" oninput="upS(${n},'${m}',this)"></math-field>`;
    p.appendChild(d);
  }

  function setCat(n,c,b){ adminCats[n]=c; b.parentElement.querySelectorAll('.cat-btn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }
  function sel(n,v,m,b){ (m==='admin'?adminKeys:studentAns)[n]=v; b.parentElement.querySelectorAll('.opt-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); }
  function upD(n,p,m,el){ let o=(m==='admin'?adminKeys:studentAns); if(!o[n])o[n]={a:'',b:''}; o[n][p]=el.value; }
  function upS(n,m,el){ (m==='admin'?adminKeys:studentAns)[n]=el.value; }

  async function submit() {
    document.getElementById('subBtn').disabled=true;
    await fetch(SCRIPT_URL, {method:'POST', body: JSON.stringify({action:"submit", userId:userId, kod: activeTest.kod, answers:studentAns})});
    tg.close();
  }
  load();
</script>
</body>
</html>
