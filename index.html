<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Tizimi</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
  <style>
    :root { --primary: #3498db; --success: #2ecc71; --bg: #f4f7f9; }
    body { margin: 0; font-family: system-ui, sans-serif; background: var(--bg); padding: 10px; }
    .container { max-width: 550px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .status-box { padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 14px; background: #e8f4fd; color: #2980b9; }
    .q-card { border-bottom: 1px solid #eee; padding: 15px 0; }
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .opt-btn { padding: 10px 14px; border: 1px solid #ccc; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; min-width: 45px; }
    .opt-btn.selected { background: var(--primary); color: white; border-color: #2980b9; }
    .sub-q { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
    math-field { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #fff; font-size: 18px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .btn-blue { background: var(--primary); }
    .btn-green { background: var(--success); }
    input[type="text"] { width: 90%; padding: 15px; margin: 15px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 20px; text-align: center; }
    #loading, #alreadyDone, #done { display: none; text-align: center; padding: 40px 0; }
  </style>
</head>
<body>

<div class="container">
  <div id="loading" style="display: block;">üîç Tekshirilmoqda...</div>

  <div id="alreadyDone">
    <h2>üö´ Topshirib bo'lingan</h2>
    <p>Sizning javoblaringiz bazada mavjud.</p>
    <button class="btn btn-blue" onclick="tg.close()">Yopish</button>
  </div>

  <div id="loginSection" style="display: none;">
    <div id="status" class="status-box"></div>
    <div id="controls" style="display: none;">
      <h2 style="text-align: center;">üîê Kirish</h2>
      <input type="text" id="code" placeholder="Kodni kiriting">
      <button class="btn btn-blue" onclick="start()">Testni ko'rish</button>
    </div>
  </div>

  <div id="testSection" style="display:none;">
    <div id="questions"></div>
    <button id="submitBtn" class="btn btn-green" onclick="submit()">üì§ Topshirish</button>
  </div>

  <div id="done">
    <h2 style="color: var(--success)">‚úÖ Saqlandi</h2>
    <p>Javoblar qabul qilindi.</p>
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready(); tg.expand();

  const CONFIG = {
    kod: "1234",
    n1: 32, n2: 3, n3: 10,
    start: new Date(2026, 0, 10, 22, 0, 0),
    end: new Date(2026, 0, 10, 24, 0, 0),
    url: "https://script.google.com/macros/s/AKfycbyKajimjH5bANA2L0dAOO5dwRBDvRpiGDTs5PBvhRUvWMgkpcdtjz3WGFc2iFiffL7w/exec" 
  };

  let answers = {};

  async function check() {
    const uid = tg.initDataUnsafe.user?.id;
    try {
      const res = await fetch(`${CONFIG.url}?userId=${uid}`);
      const status = await res.text();
      document.getElementById('loading').style.display = 'none';
      if (status === "EXISTS") {
        document.getElementById('alreadyDone').style.display = 'block';
      } else {
        document.getElementById('loginSection').style.display = 'block';
        const now = new Date();
        const s = document.getElementById('status');
        if (now < CONFIG.start) s.innerText = "‚è≥ Test hali boshlanmadi";
        else if (now > CONFIG.end) s.innerText = "‚ùå Vaqt tugagan";
        else { s.innerText = "‚úÖ Test faol"; document.getElementById('controls').style.display = 'block'; }
      }
    } catch (e) { document.getElementById('loading').innerText = "Xato!"; }
  }

  function start() {
    if (document.getElementById('code').value === CONFIG.kod) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('testSection').style.display = 'block';
      const c = document.getElementById('questions');
      let n = 1;
      for (let i=0; i<CONFIG.n1; i++) addM(c, n++, ['A','B','C','D']);
      for (let i=0; i<CONFIG.n2; i++) addM(c, n++, ['A','B','C','D','E','F']);
      for (let i=0; i<CONFIG.n3; i++) addO(c, n++);
    } else alert("Kod xato!");
  }

  function addM(p, n, os) {
    const d = document.createElement('div'); d.className = 'q-card';
    d.innerHTML = `<b>${n}.</b><div class="btn-group" id="q-${n}">
      ${os.map(o => `<button class="opt-btn" onclick="setM(${n},'${o}',this)">${o}</button>`).join('')}</div>`;
    p.appendChild(d);
  }

  function addO(p, n) {
    const d = document.createElement('div'); d.className = 'q-card';
    d.innerHTML = `<b>${n}.</b><div class="sub-q">a)<math-field id="q-${n}-a" oninput="setO(${n},'a')"></math-field></div>
      <div class="sub-q">b)<math-field id="q-${n}-b" oninput="setO(${n},'b')"></math-field></div>`;
    p.appendChild(d);
  }

  function setM(n, v, b) {
    answers[n] = v;
    document.getElementById(`q-${n}`).querySelectorAll('.opt-btn').forEach(x => x.classList.remove('selected'));
    b.classList.add('selected');
  }

  function setO(n, p) { if(!answers[n]) answers[n]={a:"",b:""}; answers[n][p]=document.getElementById(`q-${n}-${p}`).value; }

  async function submit() {
    if (new Date() > CONFIG.end) return alert("Vaqt tugadi!");
    const btn = document.getElementById('submitBtn');
    btn.disabled = true; btn.innerText = "Yuborilmoqda...";
    let f = {};
    const total = CONFIG.n1 + CONFIG.n2 + CONFIG.n3;
    for (let i=1; i<=total; i++) {
      if (typeof answers[i] === 'object') f[i] = `a:${answers[i].a || ""} b:${answers[i].b || ""}`;
      else f[i] = answers[i] || "";
    }
    try {
      await fetch(CONFIG.url, {
        method: 'POST', mode: 'no-cors',
        body: JSON.stringify({ userId: tg.initDataUnsafe.user.id, answers: f })
      });
      document.getElementById('testSection').style.display = 'none';
      document.getElementById('done').style.display = 'block';
      setTimeout(() => tg.close(), 2500);
    } catch (e) { alert("Xato!"); btn.disabled = false; }
  }
  check();
</script>
</body>
</html>

