<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Milliy Sertifikat - Repetitsion Test</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathlive"></script>
  <style>
    :root {
      --primary: #3498db;
      --success: #2ecc71;
      --bg: #f4f7f9;
      --text: #2c3e50;
    }
    body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
    .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
    
    /* Login */
    #loginSection { text-align: center; padding: 40px 0; }
    input[type="text"] { width: 80%; padding: 15px; margin: 20px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 20px; text-align: center; }

    /* Savollar */
    .q-card { border-bottom: 1px solid #eee; padding: 15px 0; margin-bottom: 10px; }
    .q-title { font-weight: bold; margin-bottom: 10px; display: block; color: #34495e; }
    
    /* Button Groups */
    .btn-group { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; }
    .opt-btn { padding: 10px 14px; border: 1px solid #ccc; border-radius: 8px; background: white; cursor: pointer; font-weight: bold; min-width: 45px; }
    .opt-btn.selected { background: var(--primary); color: white; border-color: #2980b9; }

    /* Ochiq savollar (a va b) */
    .open-q-container { display: flex; flex-direction: column; gap: 10px; margin-top: 5px; }
    .sub-q { display: flex; align-items: center; gap: 10px; }
    .sub-label { font-weight: bold; color: var(--primary); width: 20px; }
    math-field { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #ccc; background: #fff; font-size: 18px; }

    /* Footer Buttons */
    .footer-btns { display: flex; gap: 10px; margin-top: 25px; }
    .btn { flex: 1; padding: 15px; border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: bold; cursor: pointer; }
    .btn-blue { background: var(--primary); }
    .btn-green { background: var(--success); }
    .btn-red { background: #e74c3c; }

    #submitInfo { display: none; text-align: center; padding: 50px 0; color: var(--success); font-size: 22px; }
  </style>
</head>
<body>

<div class="container">
  <!-- LOGIN -->
  <div id="loginSection">
    <h2>üîê Testga kirish</h2>
    <input type="text" id="testCode" placeholder="Test kodini kiriting">
    <button class="btn btn-blue" onclick="startTest()">Kirish</button>
  </div>

  <!-- TEST -->
  <div id="testSection" style="display:none;">
    <h3 id="headerTitle" style="text-align:center; border-bottom: 2px solid var(--primary); padding-bottom: 10px;">Javoblar varaqasi</h3>
    <div id="questions"></div>
    
    <div class="footer-btns">
      <button class="btn btn-red" onclick="location.reload()">‚ôªÔ∏è Tozalash</button>
      <button id="submitBtn" class="btn btn-green" onclick="submitTest()">üì§ Topshirish</button>
    </div>
  </div>

  <!-- SUCCESS -->
  <div id="submitInfo">
    <b>‚úÖ Yakunlandi!</b><br><small>Javoblaringiz muvaffaqiyatli saqlandi.</small>
  </div>
</div>

<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxDClCkFKKHikpGR5kYrkqmzPPRK7s06f8C9QUMfKihufFxyxHLbGx-dhkZjZyZLHHW/exec"; // Google Script manzilingiz
  const LOGIN_KOD = "test1234"; // Test kodi

  let answers = {};

  function startTest() {
    const code = document.getElementById('testCode').value;
    if (code === LOGIN_KOD) {
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('testSection').style.display = 'block';
      renderQuestions();
    } else {
      alert("Kod noto'g'ri!");
    }
  }

  function renderQuestions() {
    const container = document.getElementById('questions');
    
    // 1-32: Yopiq A,B,C,D
    for (let i = 1; i <= 32; i++) {
      addMCQ(container, i, ['A', 'B', 'C', 'D']);
    }

    // 33-35: Yopiq A,B,C,D,E,F (Matching)
    for (let i = 33; i <= 35; i++) {
      addMCQ(container, i, ['A', 'B', 'C', 'D', 'E', 'F']);
    }

    // 36-45: Ochiq (a va b bandli)
    for (let i = 36; i <= 45; i++) {
      addOpenQuestion(container, i);
    }
  }

  function addMCQ(parent, num, options) {
    const div = document.createElement('div');
    div.className = 'q-card';
    div.innerHTML = `<span class="q-title">${num}-savol:</span>
      <div class="btn-group" id="q-${num}">
        ${options.map(opt => `<button class="opt-btn" onclick="setMCQ(${num}, '${opt}', this)">${opt}</button>`).join('')}
      </div>`;
    parent.appendChild(div);
  }

  function addOpenQuestion(parent, num) {
    const div = document.createElement('div');
    div.className = 'q-card';
    div.innerHTML = `<span class="q-title">${num}-savol:</span>
      <div class="open-q-container">
        <div class="sub-q"><span class="sub-label">a)</span><math-field id="q-${num}-a" oninput="setOpen(${num}, 'a')"></math-field></div>
        <div class="sub-q"><span class="sub-label">b)</span><math-field id="q-${num}-b" oninput="setOpen(${num}, 'b')"></math-field></div>
      </div>`;
    parent.appendChild(div);
  }

  function setMCQ(num, val, btn) {
    answers[num] = val;
    const group = document.getElementById(`q-${num}`);
    group.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
  }

  function setOpen(num, part) {
    if (!answers[num]) answers[num] = { a: "", b: "" };
    const val = document.getElementById(`q-${num}-${part}`).value;
    answers[num][part] = val;
  }

  async function submitTest() {
    const user = tg.initDataUnsafe.user;
    if (!user) return alert("Faqat Telegramda ishlaydi");

    const btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.innerText = "Yuborilmoqda...";

    // Barcha savollarni tekshirish (bo'sh qolgan bo'lsa "" yuborish)
    let finalData = {};
    for(let i=1; i<=45; i++) {
        if (i <= 35) finalData[i] = answers[i] || "";
        else {
            const a = (answers[i] && answers[i].a) ? answers[i].a : "";
            const b = (answers[i] && answers[i].b) ? answers[i].b : "";
            finalData[i] = `a) ${a} | b) ${b}`;
        }
    }

    try {
      await fetch(SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user: user.first_name + " " + (user.last_name || ""),
          userId: user.id,
          answers: finalData
        })
      });

      document.getElementById('testSection').style.display = 'none';
      document.getElementById('submitInfo').style.display = 'block';
      setTimeout(() => tg.close(), 3000);
    } catch (e) {
      alert("Xato: " + e);
      btn.disabled = false;
    }
  }

  window.onload = () => { localStorage.clear(); };
</script>
</body>
</html>
